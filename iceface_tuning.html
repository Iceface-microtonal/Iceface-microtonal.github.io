<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Iceface Tuning Keyboard ‚ùÑÔ∏è</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    @keyframes soft-gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; transform: scale(0.8); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }
    
    @keyframes ice-glow {
      0%, 100% { box-shadow: 0 0 10px rgba(33, 150, 243, 0.3), inset 0 0 20px rgba(255,255,255,0.3); }
      50% { box-shadow: 0 0 20px rgba(33, 150, 243, 0.5), inset 0 0 30px rgba(255,255,255,0.5); }
    }
    
    body {
      font-family: 'Nunito', 'Hiragino Kaku Gothic ProN', sans-serif;
      background: linear-gradient(180deg, 
        rgba(255,240,245,1) 0%, 
        rgba(255,255,255,1) 30%,
        rgba(255,255,255,1) 50%,
        rgba(240,255,255,1) 70%,
        rgba(255,250,240,1) 100%);
      background-size: 100% 200%;
      animation: soft-gradient 20s ease infinite;
      min-height: 100vh;
      color: #333;
      padding: 16px;
      padding-bottom: 40px;
      overflow-x: hidden;
      position: relative;
      touch-action: manipulation;
    }
    
    .sparkle-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .star {
      position: absolute;
      font-size: 14px;
      animation: twinkle 3s ease-in-out infinite;
      opacity: 0.3;
    }
    
    .content { position: relative; z-index: 1; }
    
    .header {
      text-align: center;
      margin-bottom: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(255,182,193,0.15), rgba(173,216,230,0.15));
      border-radius: 20px;
      border: 1px solid rgba(255,182,193,0.3);
    }
    .header h1 {
      font-size: 24px;
      font-weight: 900;
      background: linear-gradient(90deg, #ff6b9d, #ffb6c1, #87ceeb, #ff6b9d);
      background-size: 300% 300%;
      animation: soft-gradient 4s ease infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header p { margin-top: 6px; font-size: 12px; color: #ff6b9d; opacity: 0.8; }
    
    .keyboard-container {
      background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,240,245,0.9));
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,182,193,0.3);
      box-shadow: 0 4px 20px rgba(255,182,193,0.15);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .keyboard {
      display: flex;
      justify-content: center;
      position: relative;
      height: 180px;
      min-width: fit-content;
      margin: 0 auto;
    }
    
    .key {
      cursor: pointer;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      font-size: 9px;
      font-weight: bold;
      user-select: none;
      transition: transform 0.1s, box-shadow 0.1s;
      touch-action: manipulation;
      border-radius: 0 0 6px 6px;
    }
    
    .key.white {
      background: linear-gradient(180deg, #fff 0%, #f8f8f8 100%);
      width: 36px;
      height: 180px;
      color: #888;
      padding-bottom: 8px;
      border: 1px solid #ddd;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1;
    }
    
    .key.black {
      background: linear-gradient(180deg, #444 0%, #222 100%);
      width: 26px;
      height: 110px;
      color: #fff;
      margin-left: -13px;
      margin-right: -13px;
      z-index: 2;
      position: relative;
      padding-bottom: 8px;
      border: 1px solid #000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .key.ice {
      background: linear-gradient(180deg, #e3f2fd 0%, #90caf9 50%, #64b5f6 100%);
      color: #1565c0;
      border: 1px solid #42a5f5;
      animation: ice-glow 2s ease-in-out infinite;
    }
    
    .key:active, .key.active {
      transform: translateY(4px);
    }
    .key.white:active, .key.white.active {
      background: linear-gradient(180deg, #e8e8e8 0%, #ddd 100%);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    .key.black:active, .key.black.active {
      background: linear-gradient(180deg, #333 0%, #111 100%);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
    }
    .key.ice:active, .key.ice.active {
      background: linear-gradient(180deg, #bbdefb 0%, #64b5f6 50%, #42a5f5 100%);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 0 15px rgba(33,150,243,0.5);
    }
    
    .note-label {
      font-size: 10px;
      opacity: 0.8;
    }
    .ice-icon {
      font-size: 14px;
      margin-top: 4px;
    }
    
    .info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,182,193,0.2);
    }
    .info-text { font-size: 14px; color: #ff6b9d; }
    .current-note { font-size: 18px; font-weight: bold; color: #ff6b9d; }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .control-card {
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(255,182,193,0.2);
    }
    .control-card h3 {
      font-size: 13px;
      color: #ff6b9d;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .slider-row:last-child { margin-bottom: 0; }
    .slider-label {
      font-size: 11px;
      color: #666;
      width: 70px;
    }
    .slider {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: linear-gradient(90deg, rgba(255,182,193,0.4), rgba(173,216,230,0.4));
      border-radius: 3px;
      outline: none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, #ff6b9d, #ffb6c1);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(255,107,157,0.3);
    }
    .slider-val {
      font-size: 11px;
      color: #ff6b9d;
      width: 36px;
      text-align: right;
    }
    
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .toggle-row label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #666;
      cursor: pointer;
    }
    input[type="checkbox"] {
      accent-color: #ff6b9d;
      width: 16px;
      height: 16px;
    }
    
    .settings-toggle {
      width: 100%;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,182,193,0.25);
      background: rgba(255,255,255,0.8);
      color: #ff6b9d;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 12px;
    }
    .settings-panel {
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      display: none;
      border: 1px solid rgba(255,182,193,0.2);
    }
    .settings-panel.show { display: block; }
    
    .effect-section {
      margin-bottom: 16px;
    }
    .effect-section:last-child { margin-bottom: 0; }
    .effect-section h4 {
      font-size: 13px;
      color: #ff6b9d;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .footer {
      text-align: center;
      padding: 16px;
      color: #ffb6c1;
      font-size: 12px;
    }
    
    .cents-info {
      text-align: center;
      font-size: 11px;
      color: #ff6b9d;
      opacity: 0.7;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="sparkle-bg" id="sparkleBg"></div>
  
  <div class="content">
    <div class="header">
      <h1>‚ùÑÔ∏è Iceface Tuning Keyboard</h1>
      <p>ÈªíÈçµ„ÅåÂπ≥ÂùáÂæã„Çà„Çä50„Çª„É≥„ÉàÈ´ò„Åè„ÉÅ„É•„Éº„Éã„É≥„Ç∞„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</p>
    </div>
    
    <div class="info-bar">
      <span class="info-text">üéπ 3„Ç™„ÇØ„Çø„Éº„Éñ+1</span>
      <span class="current-note" id="currentNote">--</span>
      <span class="info-text">C4 - C7</span>
    </div>
    
    <div class="keyboard-container">
      <div class="keyboard" id="keyboard"></div>
      <div class="cents-info">
        Cents: 0, 150, 200, 350, 400, 500, 650, 700, 850, 900, 1050, 1100
      </div>
    </div>
    
    <div class="controls">
      <div class="control-card" style="grid-column: span 2;">
        <h3>üéöÔ∏è Èü≥Èáè</h3>
        <div class="slider-row">
          <input type="range" id="volume" min="0" max="100" value="50" class="slider" style="flex:1;">
          <span class="slider-val" id="volumeVal">50%</span>
        </div>
      </div>
    </div>
    
    <button class="settings-toggle" id="effectsToggle">üéõÔ∏è „Ç®„Éï„Çß„ÇØ„Éà ‚ñº</button>
    <div class="settings-panel" id="effectsPanel">
      <div class="effect-section">
        <h4>üîä „Éá„Ç£„É¨„Ç§</h4>
        <div class="toggle-row">
          <label><input type="checkbox" id="delayOn"> ON</label>
        </div>
        <div class="slider-row">
          <span class="slider-label">Time</span>
          <input type="range" id="delayTime" min="0.05" max="1.0" step="0.05" value="0.3" class="slider">
          <span class="slider-val" id="delayTimeVal">0.3s</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Feedback</span>
          <input type="range" id="delayFeedback" min="0" max="0.9" step="0.05" value="0.4" class="slider">
          <span class="slider-val" id="delayFeedbackVal">0.4</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Wet</span>
          <input type="range" id="delayWet" min="0" max="1" step="0.05" value="0.3" class="slider">
          <span class="slider-val" id="delayWetVal">0.3</span>
        </div>
      </div>
      
      <div class="effect-section">
        <h4>üåä „É™„Éê„Éº„Éñ</h4>
        <div class="toggle-row">
          <label><input type="checkbox" id="reverbOn"> ON</label>
        </div>
        <div class="slider-row">
          <span class="slider-label">Decay</span>
          <input type="range" id="reverbDecay" min="0.5" max="5.0" step="0.1" value="2.0" class="slider">
          <span class="slider-val" id="reverbDecayVal">2.0s</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Wet</span>
          <input type="range" id="reverbWet" min="0" max="1" step="0.05" value="0.3" class="slider">
          <span class="slider-val" id="reverbWetVal">0.3</span>
        </div>
      </div>
      
      <div class="effect-section">
        <h4>üîî „É™„É≥„Ç∞„É¢„Ç∏„É•„É¨„Éº„Çø„Éº</h4>
        <div class="toggle-row">
          <label><input type="checkbox" id="ringModOn"> ON</label>
        </div>
        <div class="slider-row">
          <span class="slider-label">Freq</span>
          <input type="range" id="ringModFreq" min="20" max="2000" step="10" value="440" class="slider">
          <span class="slider-val" id="ringModFreqVal">440Hz</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Wet</span>
          <input type="range" id="ringModWet" min="0" max="1" step="0.05" value="0.5" class="slider">
          <span class="slider-val" id="ringModWetVal">0.5</span>
        </div>
      </div>
      
      <div class="effect-section">
        <h4>üìä „Ç≥„É≥„Éó„É¨„ÉÉ„Çµ„Éº</h4>
        <div class="toggle-row">
          <label><input type="checkbox" id="compOn"> ON</label>
        </div>
        <div class="slider-row">
          <span class="slider-label">Threshold</span>
          <input type="range" id="compThreshold" min="-60" max="0" step="1" value="-24" class="slider">
          <span class="slider-val" id="compThresholdVal">-24dB</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Ratio</span>
          <input type="range" id="compRatio" min="1" max="20" step="0.5" value="4" class="slider">
          <span class="slider-val" id="compRatioVal">4:1</span>
        </div>
      </div>
    </div>
    
    <div class="footer">‚ùÑÔ∏è Iceface Tuning ‚Ä¢ Pure Sine Wave + ADSR + Effects ‚ùÑÔ∏è</div>
  </div>

<script>
const $ = id => document.getElementById(id);

// Iceface Tuning: ÈªíÈçµ„ÅØ+50„Çª„É≥„Éà
// Cents: C=0, C#=150, D=200, D#=350, E=400, F=500, F#=650, G=700, G#=850, A=900, A#=1050, B=1100
const NOTE_DATA = [
  { note: 'C', type: 'white', ice: false, cents: 0 },
  { note: 'C#', type: 'black', ice: true, cents: 150 },
  { note: 'D', type: 'white', ice: false, cents: 200 },
  { note: 'D#', type: 'black', ice: true, cents: 350 },
  { note: 'E', type: 'white', ice: false, cents: 400 },
  { note: 'F', type: 'white', ice: false, cents: 500 },
  { note: 'F#', type: 'black', ice: true, cents: 650 },
  { note: 'G', type: 'white', ice: false, cents: 700 },
  { note: 'G#', type: 'black', ice: true, cents: 850 },
  { note: 'A', type: 'white', ice: false, cents: 900 },
  { note: 'A#', type: 'black', ice: true, cents: 1050 },
  { note: 'B', type: 'white', ice: false, cents: 1100 },
];

let audioCtx = null;
let masterGain = null;
let delayNode = null;
let delayFeedback = null;
let delayWetGain = null;
let convolverNode = null;
let reverbWetGain = null;
let reverbDryGain = null;
let ringModOsc = null;
let ringModGain = null;
let ringModWetGain = null;
let ringModDryGain = null;
let compressorNode = null;

let volume = 0.5;
let activeNotes = new Map();

let effects = {
  delay: { on: false, time: 0.3, feedback: 0.4, wet: 0.3 },
  reverb: { on: false, decay: 2.0, wet: 0.3 },
  ringMod: { on: false, freq: 440, wet: 0.5 },
  compressor: { on: false, threshold: -24, ratio: 4 }
};

function initAudio() {
  if (audioCtx) return audioCtx;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  setupEffects();
  return audioCtx;
}

function createReverbIR(decay, duration) {
  const length = audioCtx.sampleRate * duration;
  const buffer = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
  for (let ch = 0; ch < 2; ch++) {
    const data = buffer.getChannelData(ch);
    for (let i = 0; i < length; i++) {
      data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
    }
  }
  return buffer;
}

function setupEffects() {
  masterGain = audioCtx.createGain();
  masterGain.gain.value = volume;
  
  compressorNode = audioCtx.createDynamicsCompressor();
  compressorNode.threshold.value = effects.compressor.threshold;
  compressorNode.ratio.value = effects.compressor.ratio;
  compressorNode.attack.value = 0.003;
  compressorNode.release.value = 0.25;
  
  masterGain.connect(audioCtx.destination);
  
  // Delay
  delayNode = audioCtx.createDelay(5.0);
  delayNode.delayTime.value = effects.delay.time;
  delayFeedback = audioCtx.createGain();
  delayFeedback.gain.value = effects.delay.feedback;
  delayWetGain = audioCtx.createGain();
  delayWetGain.gain.value = effects.delay.on ? effects.delay.wet : 0;
  
  delayNode.connect(delayFeedback);
  delayFeedback.connect(delayNode);
  delayNode.connect(delayWetGain);
  delayWetGain.connect(masterGain);
  
  // Reverb
  convolverNode = audioCtx.createConvolver();
  convolverNode.buffer = createReverbIR(effects.reverb.decay, 2.5);
  reverbWetGain = audioCtx.createGain();
  reverbWetGain.gain.value = effects.reverb.on ? effects.reverb.wet : 0;
  reverbDryGain = audioCtx.createGain();
  reverbDryGain.gain.value = 1.0;
  
  convolverNode.connect(reverbWetGain);
  reverbWetGain.connect(masterGain);
  reverbDryGain.connect(masterGain);
  
  // Ring Modulator
  ringModOsc = audioCtx.createOscillator();
  ringModOsc.type = 'sine';
  ringModOsc.frequency.value = effects.ringMod.freq;
  ringModGain = audioCtx.createGain();
  ringModGain.gain.value = 0;
  ringModWetGain = audioCtx.createGain();
  ringModWetGain.gain.value = effects.ringMod.on ? effects.ringMod.wet : 0;
  ringModDryGain = audioCtx.createGain();
  ringModDryGain.gain.value = 1.0;
  
  ringModOsc.connect(ringModGain.gain);
  ringModGain.connect(ringModWetGain);
  ringModWetGain.connect(masterGain);
  ringModDryGain.connect(masterGain);
  ringModOsc.start();
}

function centsToFreq(cents, octave) {
  // A4 = 440Hz, A is at 900 cents in our scale
  // C4 = 440 * 2^(-9/12) = 261.63Hz
  const c4 = 261.63;
  const octaveOffset = octave - 4;
  return c4 * Math.pow(2, octaveOffset) * Math.pow(2, cents / 1200);
}

function playNote(noteData, octave) {
  const ctx = initAudio();
  const noteKey = `${noteData.note}${octave}`;
  
  if (activeNotes.has(noteKey)) return;
  
  const now = ctx.currentTime;
  const freq = centsToFreq(noteData.cents, octave);
  const vol = volume * 0.4;
  
  const osc = ctx.createOscillator();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freq, now);
  
  const gain = ctx.createGain();
  
  // ADSR Envelope
  const attack = 0.005;
  const decay = 0.3;
  const sustainLevel = 0.3;
  
  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(vol, now + attack);
  gain.gain.exponentialRampToValueAtTime(Math.max(0.001, vol * sustainLevel), now + attack + decay);
  
  osc.connect(gain);
  
  // Connect to effects
  gain.connect(reverbDryGain);
  gain.connect(convolverNode);
  gain.connect(delayNode);
  
  if (effects.ringMod.on) {
    gain.connect(ringModGain);
    gain.connect(ringModDryGain);
  } else {
    gain.connect(ringModDryGain);
  }
  
  osc.start(now);
  
  activeNotes.set(noteKey, { osc, gain, noteData, octave });
  
  // Update display
  const displayNote = noteData.ice ? `${noteData.note} ‚ùÑÔ∏è (+50c)` : noteData.note;
  $('currentNote').textContent = `${displayNote}${octave}`;
}

function stopNote(noteData, octave) {
  const noteKey = `${noteData.note}${octave}`;
  const active = activeNotes.get(noteKey);
  
  if (!active) return;
  
  const { osc, gain } = active;
  const now = audioCtx.currentTime;
  const release = 0.5;
  
  gain.gain.cancelScheduledValues(now);
  gain.gain.setValueAtTime(gain.gain.value, now);
  gain.gain.exponentialRampToValueAtTime(0.001, now + release);
  
  osc.stop(now + release + 0.1);
  activeNotes.delete(noteKey);
}

function generateKeyboard() {
  const keyboard = $('keyboard');
  keyboard.innerHTML = '';
  
  // C4„Åã„ÇâB6„Åæ„Åß„ÅÆ3„Ç™„ÇØ„Çø„Éº„Éñ + C7
  for (let oct = 4; oct <= 6; oct++) {
    NOTE_DATA.forEach(nd => {
      createKey(keyboard, nd, oct);
    });
  }
  
  // ÊúÄÂæå„Å´C7„ÇíËøΩÂä†
  const c7Data = NOTE_DATA[0]; // C
  createKey(keyboard, c7Data, 7);
}

function createKey(keyboard, nd, oct) {
  const key = document.createElement('div');
  key.className = `key ${nd.type}${nd.ice ? ' ice' : ''}`;
  key.dataset.note = nd.note;
  key.dataset.octave = oct;
  
  if (nd.type === 'white') {
    key.innerHTML = `<span class="note-label">${nd.note}${oct}</span>`;
  } else {
    key.innerHTML = `<span class="ice-icon">‚ùÑÔ∏è</span><span class="note-label">${nd.note}</span>`;
  }
  
  // Touch events
  key.addEventListener('touchstart', e => {
    e.preventDefault();
    key.classList.add('active');
    playNote(nd, oct);
  });
  key.addEventListener('touchend', e => {
    e.preventDefault();
    key.classList.remove('active');
    stopNote(nd, oct);
  });
  key.addEventListener('touchcancel', e => {
    e.preventDefault();
    key.classList.remove('active');
    stopNote(nd, oct);
  });
  
  // Mouse events
  key.addEventListener('mousedown', () => {
    key.classList.add('active');
    playNote(nd, oct);
  });
  key.addEventListener('mouseup', () => {
    key.classList.remove('active');
    stopNote(nd, oct);
  });
  key.addEventListener('mouseleave', () => {
    if (key.classList.contains('active')) {
      key.classList.remove('active');
      stopNote(nd, oct);
    }
  });
  
  keyboard.appendChild(key);
}

function createSparkles() {
  const bg = $('sparkleBg');
  const stars = ['‚ú¶', '‚úß', '‚ãÜ', 'ÔΩ°', 'Àö', '‚ú©', '‚äπ'];
  
  for (let i = 0; i < 20; i++) {
    const star = document.createElement('span');
    star.className = 'star';
    star.textContent = stars[Math.floor(Math.random() * stars.length)];
    star.style.left = Math.random() * 100 + '%';
    star.style.top = Math.random() * 100 + '%';
    star.style.animationDelay = Math.random() * 3 + 's';
    star.style.color = ['#ffb6c1', '#add8e6', '#ffe4e1', '#e6e6fa'][Math.floor(Math.random() * 4)];
    bg.appendChild(star);
  }
}

function updateDelayParams() {
  if (!delayNode) return;
  delayNode.delayTime.value = effects.delay.time;
  delayFeedback.gain.value = effects.delay.feedback;
  delayWetGain.gain.value = effects.delay.on ? effects.delay.wet : 0;
}

function updateReverbParams() {
  if (!convolverNode) return;
  convolverNode.buffer = createReverbIR(effects.reverb.decay, 2.5);
  reverbWetGain.gain.value = effects.reverb.on ? effects.reverb.wet : 0;
}

function updateRingModParams() {
  if (!ringModOsc) return;
  ringModOsc.frequency.value = effects.ringMod.freq;
  ringModWetGain.gain.value = effects.ringMod.on ? effects.ringMod.wet : 0;
  ringModDryGain.gain.value = effects.ringMod.on ? (1 - effects.ringMod.wet) : 1.0;
}

function updateCompressorParams() {
  if (!compressorNode) return;
  compressorNode.threshold.value = effects.compressor.threshold;
  compressorNode.ratio.value = effects.compressor.ratio;
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  createSparkles();
  generateKeyboard();
  
  // Volume control
  $('volume').addEventListener('input', e => {
    volume = e.target.value / 100;
    $('volumeVal').textContent = e.target.value + '%';
    if (masterGain) masterGain.gain.value = volume;
  });
  
  // Effects toggle
  $('effectsToggle').addEventListener('click', () => {
    const panel = $('effectsPanel');
    const showing = panel.classList.toggle('show');
    $('effectsToggle').textContent = `üéõÔ∏è „Ç®„Éï„Çß„ÇØ„Éà ${showing ? '‚ñ≤' : '‚ñº'}`;
  });
  
  // Delay controls
  $('delayOn').addEventListener('change', e => {
    effects.delay.on = e.target.checked;
    updateDelayParams();
  });
  $('delayTime').addEventListener('input', e => {
    effects.delay.time = parseFloat(e.target.value);
    $('delayTimeVal').textContent = e.target.value + 's';
    updateDelayParams();
  });
  $('delayFeedback').addEventListener('input', e => {
    effects.delay.feedback = parseFloat(e.target.value);
    $('delayFeedbackVal').textContent = e.target.value;
    updateDelayParams();
  });
  $('delayWet').addEventListener('input', e => {
    effects.delay.wet = parseFloat(e.target.value);
    $('delayWetVal').textContent = e.target.value;
    updateDelayParams();
  });
  
  // Reverb controls
  $('reverbOn').addEventListener('change', e => {
    effects.reverb.on = e.target.checked;
    updateReverbParams();
  });
  $('reverbDecay').addEventListener('input', e => {
    effects.reverb.decay = parseFloat(e.target.value);
    $('reverbDecayVal').textContent = e.target.value + 's';
    updateReverbParams();
  });
  $('reverbWet').addEventListener('input', e => {
    effects.reverb.wet = parseFloat(e.target.value);
    $('reverbWetVal').textContent = e.target.value;
    updateReverbParams();
  });
  
  // Ring Mod controls
  $('ringModOn').addEventListener('change', e => {
    effects.ringMod.on = e.target.checked;
    updateRingModParams();
  });
  $('ringModFreq').addEventListener('input', e => {
    effects.ringMod.freq = parseFloat(e.target.value);
    $('ringModFreqVal').textContent = e.target.value + 'Hz';
    updateRingModParams();
  });
  $('ringModWet').addEventListener('input', e => {
    effects.ringMod.wet = parseFloat(e.target.value);
    $('ringModWetVal').textContent = e.target.value;
    updateRingModParams();
  });
  
  // Compressor controls
  $('compOn').addEventListener('change', e => {
    effects.compressor.on = e.target.checked;
    if (audioCtx) {
      if (e.target.checked) {
        masterGain.disconnect();
        masterGain.connect(compressorNode);
        compressorNode.connect(audioCtx.destination);
      } else {
        masterGain.disconnect();
        try { compressorNode.disconnect(); } catch(e) {}
        masterGain.connect(audioCtx.destination);
      }
    }
  });
  $('compThreshold').addEventListener('input', e => {
    effects.compressor.threshold = parseFloat(e.target.value);
    $('compThresholdVal').textContent = e.target.value + 'dB';
    updateCompressorParams();
  });
  $('compRatio').addEventListener('input', e => {
    effects.compressor.ratio = parseFloat(e.target.value);
    $('compRatioVal').textContent = e.target.value + ':1';
    updateCompressorParams();
  });
  
  // Keyboard input (Âõ∫ÂÆö: C4„Åã„ÇâÈñãÂßã)
  const keyMap = {
    'a': { note: 'C', oct: 4 },
    'w': { note: 'C#', oct: 4 },
    's': { note: 'D', oct: 4 },
    'e': { note: 'D#', oct: 4 },
    'd': { note: 'E', oct: 4 },
    'f': { note: 'F', oct: 4 },
    't': { note: 'F#', oct: 4 },
    'g': { note: 'G', oct: 4 },
    'y': { note: 'G#', oct: 4 },
    'h': { note: 'A', oct: 4 },
    'u': { note: 'A#', oct: 4 },
    'j': { note: 'B', oct: 4 },
    'k': { note: 'C', oct: 5 },
    'o': { note: 'C#', oct: 5 },
    'l': { note: 'D', oct: 5 },
    'p': { note: 'D#', oct: 5 },
    ';': { note: 'E', oct: 5 },
    "'": { note: 'F', oct: 5 },
  };
  
  const pressedKeys = new Set();
  
  document.addEventListener('keydown', e => {
    const k = e.key.toLowerCase();
    if (keyMap[k] && !pressedKeys.has(k)) {
      pressedKeys.add(k);
      const { note, oct } = keyMap[k];
      const nd = NOTE_DATA.find(n => n.note === note);
      if (nd) {
        playNote(nd, oct);
        const keyEl = document.querySelector(`[data-note="${note}"][data-octave="${oct}"]`);
        if (keyEl) keyEl.classList.add('active');
      }
    }
  });
  
  document.addEventListener('keyup', e => {
    const k = e.key.toLowerCase();
    if (keyMap[k]) {
      pressedKeys.delete(k);
      const { note, oct } = keyMap[k];
      const nd = NOTE_DATA.find(n => n.note === note);
      if (nd) {
        stopNote(nd, oct);
        const keyEl = document.querySelector(`[data-note="${note}"][data-octave="${oct}"]`);
        if (keyEl) keyEl.classList.remove('active');
      }
    }
  });
});
</script>
</body>
</html>
